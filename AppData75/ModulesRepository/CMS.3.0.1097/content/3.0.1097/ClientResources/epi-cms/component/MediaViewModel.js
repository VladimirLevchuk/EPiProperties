//>>built
define("epi-cms/component/MediaViewModel",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/dom-class","dojo/when","epi","epi/shell/widget/dialog/Dialog","epi-cms/core/ContentReference","epi-cms/widget/ContextualContentForestStoreModel","epi-cms/widget/viewmodel/HierarchicalListViewModel","epi-cms/widget/viewmodel/MultipleFileUploadViewModel","epi-cms/widget/MultipleFileUpload","epi-cms/widget/UploadUtil","epi-cms/command/UploadContent","epi-cms/command/EditImage","epi-cms/command/DownloadMedia","epi/i18n!epi/cms/nls/episerver.cms.components.media"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11){return _2([_a],{treeStoreModelClass:_9,_dialog:null,_getTypesToCreate:function(){return [];},_setupCommands:function(){this.inherited(arguments);var _12={selection:this.selection,model:this};var _13={uploadDefault:{command:new _e(_3.mixin({iconClass:"epi-iconPlus",label:_11.command.label,resources:_11,viewModel:this},_12))},upload:{command:new _e(_3.mixin({category:"context",iconClass:"epi-iconUpload",label:_11.linktocreateitem,viewModel:this},_12)),isAvailable:this.menuType.ROOT|this.menuType.TREE,order:2},editImage:{command:new _f(_3.mixin({category:"context",forceContextChange:true,label:_11.command.openineditor},_12)),isAvailable:this.menuType.LIST,order:3},download:{command:new _10(_3.mixin({category:"context",label:_11.command.download},_12)),isAvailable:this.menuType.LIST,order:4}};this._commandRegistry=_3.mixin(this._commandRegistry,_13);this.pseudoContextualCommands.push(this._commandRegistry.uploadDefault.command);this.pseudoContextualCommands.push(this._commandRegistry.upload.command);},_updateTreeContextCommandModels:function(_14){this.inherited(arguments);this._commandRegistry.uploadDefault.command.set("model",_14);this._commandRegistry.upload.command.set("model",_14);},upload:function(_15,_16,_17){var _18=new _c({model:new _b({store:this.get("store"),query:this.get("listQuery")})});_18.on("beforeUploaderChange",_3.hitch(this,function(){this._uploading=true;}));_18.on("close",_3.hitch(this,function(_19){this._dialog&&(_19?this._dialog.hide():this._dialog.destroy());}));_18.on("uploadComplete",_3.hitch(this,function(_1a){if(_18.createAsLocalAsset){_5(this.treeStoreModel&&typeof this.treeStoreModel.refreshRoots==="function"&&this.treeStoreModel.refreshRoots(this),_3.hitch(this,function(){_18.set("createAsLocalAsset",false);_18.set("uploadDirectory",this.get("currentTreeItem").id);_18.model.set("query",this.get("listQuery"));}));}else{this.onListItemUpdated(_1a);this.set("currentTreeItem",this.get("currentTreeItem"));}if(this._dialog&&!this._dialog.open){this._dialog.destroy();}this._uploading=false;}));this._dialog=new _7({title:_11.linktocreateitem,content:_18,autofocus:_d.supportNativeDndFiles(),defaultActionsVisible:false,closeIconVisible:false});_4.add(this._dialog.domNode,"epi-multiFileUploadDialog");this._dialog.definitionConsumer.add({name:"close",label:_6.resources.action.close,action:function(){_18.close();}});this._dialog.resize({w:700});this._dialog.show();var _1b=_17?this.selection.data[0].data:this.store.get(_16);_5(_1b,_3.hitch(this,function(_1c){this._buildBreadcrumb(_1c,_18);_18.set("uploadDirectory",_16||this.get("currentTreeItem").id);_18.set("createAsLocalAsset",_17);_18.upload(_15);}));},onListItemUpdated:function(_1d){var _1e=this.store;return _5(this.getCurrentContext(),function(_1f){var _20=(new _8(_1f.id)).createVersionUnspecificReference().toString();return _5(_1e.get(_20),function(_21){var _22=_1.filter(_1d,function(_23){return _21.name.toLowerCase()===_23.fileName.toLowerCase();})[0];return _22?_21:null;});});},_buildBreadcrumb:function(_24,_25){if(!_25){return;}if(this.treeStoreModel.isTypeOfRoot(_24)){_25.set("breadcrumb",[_24]);return;}this.treeStoreModel.getAncestors(_24.contentLink,_3.hitch(this,function(_26){var _27,_28=[_24];for(var i=_26.length-1;i>=0;i--){_27=_26[i];_28.unshift(_27);if(this.treeStoreModel.isTypeOfRoot(_27)){break;}}_25.set("breadcrumb",_28);}));}});});