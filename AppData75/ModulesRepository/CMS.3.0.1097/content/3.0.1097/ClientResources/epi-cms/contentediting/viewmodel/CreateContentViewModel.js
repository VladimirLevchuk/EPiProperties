//>>built
define("epi-cms/contentediting/viewmodel/CreateContentViewModel",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/_base/json","dojo/Stateful","dojo/string","dojo/when","dojo/Evented","epi/dependency","epi/shell/TypeDescriptorManager","epi-cms/core/ContentReference","epi-cms/contentediting/ContentEditingValidator","epi/i18n!epi/cms/nls/episerver.cms.components.requiredproperties"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d){return _2([_5,_8],{_topLevelContainerType:"epi/shell/layout/SimpleContainer",_groupContainerType:"epi-cms/layout/CreateContentGroupContainer",contentDataStore:null,metadataManager:null,typeIdentifierManager:null,validator:null,parent:null,contentTypeId:null,requestedType:null,createAsLocalAsset:null,canChangeLocalAssetName:null,addToDestination:null,wizardStep:0,startWizardStep:0,contentName:null,ignoreDefaultNameWarning:null,properties:null,headingText:null,createAsLocalAssetHelpText:null,namePanelIsVisible:null,headingPanelIsVisible:null,seamlessTopPanel:null,saveButtonIsVisible:null,saveButtonDisabled:null,showAllProperties:null,showCurrentNodeOnBreadcrumb:null,actualParentLink:null,metadata:null,postscript:function(){this.inherited(arguments);if(!this.contentDataStore){var _e=_9.resolve("epi.storeregistry");this.contentDataStore=_e.get("epi.cms.contentdata");}this.metadataManager=this.metadataManager||_9.resolve("epi.shell.MetadataManager");this.validator=this.validator||new _c({contextTypeName:"epi.cms.contentdata"});this.set("propertyFilter",_3.hitch(this,this._propertyFilter));},update:function(_f){this.set("ignoreDefaultNameWarning",false);this.set("properties",null);this.set("saveButtonIsVisible",false);this.set("wizardStep",this.startWizardStep);this.set("isContentTypeSelected",false);if(_f){_1.forEach(["requestedType","parent","canChangeLocalAssetName","createAsLocalAsset","addToDestination","contentTypeId"],function(_10){this.set(_10,_f[_10]);},this);}if(this.parent){var _11=this.parent.contentLink+"_new_content";this.validator.clearErrorsBySource();this.validator.setContextId(_11);this.set("notificationContext",{contextTypeName:"epi.cms.contentdata",contextId:_11});}},save:function(){this.set("saveButtonDisabled",true);if(!this.ignoreDefaultNameWarning&&(this.canChangeLocalAssetName||!this.createAsLocalAsset)&&(!this.contentName||this.contentName===""||this.contentName===this.defaultName)){this._emitSaveEvent("invalidContentName",this.contentName);return;}this.validator.clearErrorsBySource(this.validator.validationSource.server);_7(this.validator.validate(),_3.hitch(this,function(_12){if(_12){this._emitSaveEvent("validationError");return;}var _13=this.buildContentObject();this.contentDataStore.put(_13).then(_3.hitch(this,this._saveSuccessHandler),_3.hitch(this,this._saveErrorHandler));}),_3.hitch(this,function(){this._emitSaveEvent("validationError");}));},_emitSaveEvent:function(_14,_15){this.set("saveButtonDisabled",false);this.emit(_14,_15);},cancel:function(){this.addToDestination&&(typeof this.addToDestination.cancel==="function")&&this.addToDestination.cancel();},_propertyFilter:function(_16,_17){var _18=_17.originalGroupName!=="EPiServerCMS_SettingsPanel"&&_17.originalGroupName!=="Advanced";var _19=this._isRequiredProperty(_16,_17);if(this.showAllProperties){return _18||_19;}else{return _19;}},_saveSuccessHandler:function(_1a){var ref=new _b(_1a),_1b=ref.createVersionUnspecificReference(),_1c=_3.hitch(this,function(_1d){this._emitSaveEvent("saveSuccess",{newContentLink:_1d,changeContext:true});});_7(this.contentDataStore.refresh(_1a),_3.hitch(this,function(_1e){if(this.addToDestination){this.addToDestination.save({contentLink:_1b.toString(),name:_1e.name,typeIdentifier:this.requestedType});this._emitSaveEvent("saveSuccess",{changeContext:false});}else{_1c(_1b.toString());}}));},_saveErrorHandler:function(err){if(err&&err.responseText){var _1f=_4.fromJson(err.responseText);_1.forEach(_1f,function(_20){if(_20.propertyName){this.validator.setPropertyErrors(_20.propertyName,[{severity:_20.severity,errorMessage:_20.errorMessage}],this.validator.validationSource.server);}else{this.validator.setGlobalErrors([{severity:_20.severity,errorMessage:_20.errorMessage}],this.validator.validationSource.server);}},this);}else{if(err){this.validator.setGlobalErrors([{severity:this.validator.severity.error,errorMessage:err.message}],this.validator.validationSource.server);}}this._emitSaveEvent("saveError",err);},buildContentObject:function(){return {name:(!this.createAsLocalAsset||this.canChangeLocalAssetName)?_6.trim(this.contentName+""):null,parentLink:this.parent?this.parent.contentLink:null,contentTypeId:this.contentTypeId,properties:this.properties,createAsLocalAsset:this.createAsLocalAsset};},addInvalidProperty:function(_21,_22){this.validator.setPropertyErrors(_21,[{severity:this.validator.severity.error,errorMessage:_22}],this.validator.validationSource.client);},removeInvalidProperty:function(_23){this.validator.clearPropertyErrors(_23);},_contentTypeIdSetter:function(_24){this.contentTypeId=_24;if(_24&&this.parent){this.set("isContentTypeSelected",true);_7(this._getMetadata(this.parent.contentLink,_24),_3.hitch(this,function(_25){if(!this.canChangeLocalAssetName||this._hasRequiredProperties(_25)){_25=this._regroupProperties(_25);this.set("metadata",_25);this.set("wizardStep",1);this.set("saveButtonIsVisible",true);}else{this.save();}}));}},_canChangeLocalAssetNameSetter:function(_26){this.canChangeLocalAssetName=_26==null?true:_26;},_createAsLocalAssetSetter:function(_27){var _28=this.canChangeLocalAssetName||!_27;this.set("namePanelIsVisible",_28);this.set("headingPanelIsVisible",_28);this.set("showAllProperties",!this.canChangeLocalAssetName);this.set("showCurrentNodeOnBreadcrumb",_28);this.set("seamlessTopPanel",_28);if(this.parent){this.set("actualParentLink",_27?this.parent.assetsFolderLink:this.parent.contentLink);}this.createAsLocalAsset=_27;},_parentSetter:function(_29){this.parent=_29;var _2a=this.parent.typeIdentifier,_2b=_a.getResourceValue(this.requestedType,"name"),_2c=_a.getResourceValue(_2a,"name"),_2d=_a.getResourceValue(_2a,"createaslocalassethelptext");if(_2b&&_2c){_2d=_3.replace(_2d,[_2b.toLowerCase(),_2c.toLowerCase()]);}this.set("createAsLocalAssetHelpText",_2d);},_requestedTypeSetter:function(_2e){var _2f=_a.getResourceValue(_2e,"create"),_30=_a.getResourceValue(_2e,"newitemdefaultname");this.defaultName=_30;this.set("headingText",_2f);this.set("contentName",_30);this.requestedType=_2e;},_hasRequiredProperties:function(_31){return _1.some(_31.properties,function(_32){return this._isRequiredProperty(_31,_32);},this);},_isRequired:function(_33){return _33.settings&&_33.settings.required;},_isRequiredProperty:function(_34,_35){var _36=!_35.additionalValues.hasValue;var _37=_35.showForEdit&&_1.every(_34.groups,function(_38){return (_38.name!==_35.groupName&&_38.name!==_35.originalGroupName)||_38.displayUI;});var _39=_1.some(_35.properties,function(_3a){return this._isRequiredProperty(_35,_3a);},this);return (this._isRequired(_35)||_39)&&_36&&_37&&(_35.name!=="icontent_name");},_regroupProperties:function(_3b){_3b=_3.clone(_3b);_3b.layoutType=this._topLevelContainerType;_1.forEach(_3b.properties,function(_3c){var _3d=this._isRequiredProperty(_3b,_3c);_3c.originalGroupName=_3c.groupName;_3c.groupName=_3d?"required":"additional";},this);_3b.groups=[{name:"required",displayUI:true,title:_d.groups.required,uiType:this._groupContainerType},{name:"additional",displayUI:true,title:_d.groups.additional,uiType:this._groupContainerType}];return _3b;},_getMetadata:function(_3e,_3f){return this.metadataManager.getMetadataForType("EPiServer.Core.ContentData",{parentLink:_3e,contentTypeId:_3f});}});});